<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeSeq</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="menu">
        <div class="menu-item" id="title">VibeSeq</div>
        <button class="menu-item" id="play-button">Play</button>
        <div class="menu-item">
            <div>BPM: <input type="number" id="tempo" value="120" min="60" max="200"></div>
        </div>
        <div class="right-menu">
            <button class="menu-item" id="help-button">Help</button>
            <button class="menu-item" id="midi-button">Settings</button>
            <button class="menu-item" id="json-button">Export</button>
        </div>
    </div>
    <div id="context-menu">
        <!-- Context Menu Tabs -->
        <div class="context-tabs">
            <div class="context-tab active" data-tab="rhythm">Rhythm</div>
            <div class="context-tab" data-tab="melody">Melody</div>
        </div>
        
        <!-- Context Menu Content -->
        <div class="context-content">
            <!-- Selection Title -->
            <div class="context-section title" id="selection-title">
                <span id="selection-title-text">No Selection</span>
            </div>
            
            <!-- Rhythm Tab Panel -->
            <div class="context-tab-panel active" id="rhythm-panel">
                <div class="context-row">
                    <div class="context-section" id="mod-section">
                        <span class="context-label">Mod:</span>
                        <input type="number" class="param-input" id="mod-input" min="1" max="32" placeholder="1">
                    </div>
                    
                    <div class="context-section" id="odds-section">
                        <span class="context-label">Odds:</span>
                        <input type="number" class="param-input" id="odds-input" min="0" max="1" step="0.1" placeholder="1.0">
                    </div>
                </div>
                
                <div class="context-row">
                    <div class="context-section" id="operations-section">
                        <span class="context-label">Operations:</span>
                        <button class="operation-button" id="inverse-button">Inverse</button>
                        <button class="operation-button" id="rotate-left-button">← Rotate</button>
                        <button class="operation-button" id="rotate-right-button">Rotate →</button>
                        <button class="operation-button" id="subdivide-button">Subdivide</button>
                        <button class="operation-button" id="break-subdivision-button">Break Sub</button>
                        <button class="operation-button" id="clear-button">Clear</button>
                    </div>
                </div>
                
                <div class="context-row" id="subdivision-controls" style="display: none;">
                    <div class="context-section">
                        <span class="context-label">Subdivide:</span>
                        <select id="subdivision-type">
                            <option value="2">2</option>
                            <option value="3" selected>3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="8">8</option>
                        </select>
                        <button class="operation-button" id="create-subdivision">Create</button>
                        <button class="operation-button" id="cancel-subdivision">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Melody Tab Panel -->
            <div class="context-tab-panel" id="melody-panel">
                <div class="context-row">
                    <div class="context-section" id="note-section">
                        <span class="context-label">Note:</span>
                        <input type="number" class="param-input" id="note-input" min="0" max="127" value="36">
                    </div>
                    
                    <div class="context-section" id="channel-section">
                        <span class="context-label">Channel:</span>
                        <input type="number" class="param-input" id="channel-input" min="1" max="16" value="9">
                    </div>
                    
                    <div class="context-section" id="velocity-section">
                        <span class="context-label">Velocity:</span>
                        <input type="number" class="param-input" id="velocity-input" min="1" max="127" value="100">
                    </div>
                </div>
                
                <div class="context-row">
                    <div class="context-section" id="pitch-section">
                        <span class="context-label">Pitch:</span>
                                <input type="number" class="param-input" id="pitch-input" min="0" max="127" value="0" style="width: 60px;">
                            </div>
                            
                            <div class="context-section" id="octave-section">
                                <span class="context-label">Octave:</span>
                                <input type="number" class="param-input" id="octave-input" min="0" max="10" value="3" style="width: 50px;">
                            </div>
                            
                            <div class="context-section" id="scale-section">
                                <span class="context-label">Scale:</span>
                                <input type="number" class="param-input" id="scale-input" min="0" max="4095" value="4095" placeholder="4095" style="width: 80px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
    
    <!-- JSON Modal -->
    <div id="json-modal">
        <div id="json-content">
            <div id="json-header">
                <div id="json-title">Sequencer Data JSON</div>
                <button id="json-close">Close</button>
            </div>
            <div id="json-display">
                <pre id="json-text"></pre>
            </div>
        </div>
    </div>

    <!-- HELP modal -->
     <!-- Help Modal -->
        <div id="help-modal" class="modal">
            <div id="help-content" class="modal-content">
                <div id="help-header" class="modal-header">
                    <h2 id="help-title">Sequencer Help</h2>
                    <button id="help-close" class="modal-close-button">×</button>
                </div>
                <div id="help-display" class="modal-body">
                    <div class="help-section">
                        <h3>Modes</h3>
                        <div class="help-content">
                            <div class="help-item">
                                <strong>Rhythm Mode:</strong> Edit step timing and activation
                                <ul>
                                    <li>Left click: Toggle step on/off</li>
                                    <li>Steps show as red (active) or grey (inactive)</li>
                                </ul>
                            </div>
                            <div class="help-item">
                                <strong>Melody Mode:</strong> Edit pitch and musical content
                                <ul>
                                    <li>Left click: Set pitch based on click height</li>
                                    <li>Click same pitch again: Turn step off</li>
                                    <li>Bottom 10% of step: Turn step off</li>
                                    <li>Red bars show pitch height</li>
                                    <li>Orange bars show track default pitch</li>
                                    <li>Blue dots indicate steps with custom properties</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Selection & Navigation</h3>
                        <div class="help-content">
                            <div class="help-item">
                                <strong>Selection:</strong>
                                <ul>
                                    <li><kbd>Left Click</kbd>: Select single step</li>
                                    <li><kbd>Shift + Click</kbd>: Extend selection</li>
                                    <li><kbd>Right Click</kbd>: Context menu or clear selection</li>
                                    <li><kbd>Esc</kbd>: Clear selection</li>
                                </ul>
                            </div>
                            <div class="help-item">
                                <strong>Navigation:</strong>
                                <ul>
                                    <li><kbd>←→</kbd>: Move selection left/right</li>
                                    <li><kbd>↑↓</kbd>: Move selection up/down (tracks)</li>
                                    <li><kbd>Shift + ←→</kbd>: Extend selection</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Rhythm Mode Shortcuts</h3>
                        <div class="help-content">
                            <div class="help-item">
                                <ul>
                                    <li><kbd>Space</kbd>: Inverse selection (toggle all selected steps)</li>
                                    <li><kbd>Backspace</kbd>: Clear step properties</li>
                                    <li><kbd>0-9, T, E</kbd>: Create quick subdivision</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Melody Mode Shortcuts</h3>
                        <div class="help-content">
                            <div class="help-item">
                                <ul>
                                    <li><kbd>↑↓</kbd>: Change pitch of selected steps individually</li>
                                    <li><kbd>0-9, T, E</kbd>: Set pitch to specific value (0-11)</li>
                                    <li><kbd>Space</kbd>: Inverse selection</li>
                                    <li><kbd>Backspace</kbd>: Clear step properties</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Track Controls</h3>
                        <div class="help-content">
                            <div class="help-item">
                                <strong>Track Selection:</strong>
                                <ul>
                                    <li>Click track header to select entire track</li>
                                    <li>Changes affect track defaults and existing explicit values</li>
                                    <li>Arrow keys: Change defaults + any explicit step values</li>
                                    <li>Numbers: Set same value to defaults + explicit step values</li>
                                </ul>
                            </div>
                            <div class="help-item">
                                <strong>Track Operations:</strong>
                                <ul>
                                    <li><kbd>▲/▼</kbd>: Minimize/maximize track</li>
                                    <li><kbd>×</kbd>: Remove track (with confirmation)</li>
                                    <li><kbd>Clone</kbd>: Duplicate track</li>
                                    <li>Length controls: Adjust track length (1-32 steps)</li>
                                    <li>Pulses controls: Generate Euclidean rhythms</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Subdivisions</h3>
                        <div class="help-content">
                            <div class="help-item">
                                <ul>
                                    <li>Select steps and use "Subdivide" to create subdivisions</li>
                                    <li>Numbers in rhythm mode create quick subdivisions</li>
                                    <li>"Break Subdivision" removes subdivision structure</li>
                                    <li>Subdivisions can be nested multiple levels deep</li>
                                    <li>Labels show original steps / subdivision count</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>Context Menu</h3>
                        <div class="help-content">
                            <div class="help-item">
                                <strong>Properties:</strong> Note, Channel, Velocity, Mod, Odds
                            </div>
                            <div class="help-item">
                                <strong>Melody Controls:</strong> Pitch, Octave, Scale
                            </div>
                            <div class="help-item">
                                <strong>Operations:</strong> Inverse, Rotate, Subdivide, Clear
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3>General Shortcuts</h3>
                        <div class="help-content">
                            <div class="help-item">
                                <ul>
                                    <li><kbd>F1</kbd> or <kbd>?</kbd>: Show this help</li>
                                    <li><kbd>Esc</kbd>: Close modals and clear selection</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- MIDI Modal -->
    <div id="midi-modal">
        <div id="midi-content">
            <div id="midi-header">
                <div id="midi-title">MIDI Settings</div>
                <button id="midi-close">Close</button>
            </div>
            <div id="midi-settings">
                <div class="midi-section">
                    <h3>Connection Status</h3>
                    <div id="midi-status" class="midi-status disconnected">
                        MIDI not available
                    </div>
                </div>
                
                <div class="midi-section">
                    <h3>Output Ports</h3>
                    <div class="midi-row">
                        <span class="midi-label">Output Port:</span>
                        <select id="midi-output-select" class="midi-select">
                            <option value="">No MIDI outputs available</option>
                        </select>
                        <button class="refresh-button" id="refresh-midi">Refresh</button>
                    </div>
                </div>
                
                <div class="midi-section">
                    <h3>Test</h3>
                    <div class="midi-row">
                        <span class="midi-label">Test Note:</span>
                        <input type="number" id="test-note" value="60" min="0" max="127" style="width: 60px; padding: 4px; background: #345; color: #fff; border: 1px solid #567; border-radius: 3px;">
                        <button class="refresh-button" id="test-midi">Send Test Note</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Dialog -->
    <div id="confirm-dialog">
        <div class="confirm-content">
            <div class="confirm-title" id="confirm-title">Confirm Action</div>
            <div class="confirm-message" id="confirm-message">Are you sure?</div>
            <div class="confirm-buttons">
                <button class="confirm-button yes" id="confirm-yes">Yes</button>
                <button class="confirm-button no" id="confirm-no">No</button>
            </div>
        </div>
    </div>
    
    <div id="sequencer"></div>

    <!-- AudioWorklet Clock Processor -->
    <script type="text/plain" id="clock-worklet">
        class ClockProcessor extends AudioWorkletProcessor {
        constructor() {
            super();
            this.tickInterval = 128 / sampleRate; // ~2.9 ms at 44.1kHz
            this.nextTickTime = currentTime + this.tickInterval;
            this.running = false;

            this.port.onmessage = (e) => {
            if (e.data === "start") {
                this.running = true;
                this.nextTickTime = currentTime + this.tickInterval;
            } else if (e.data === "stop") {
                this.running = false;
            }
            };
        }

        process() {
            if (!this.running) return true;

            while (currentTime >= this.nextTickTime) {
                this.port.postMessage(this.nextTickTime);
                this.nextTickTime += this.tickInterval;
            }

            return true;
        }
        }
        registerProcessor("clock", ClockProcessor);
    </script>
    <script src="midi.js"></script>
    <!-- const sequencerdata -->
    <script src="init-steps.js"></script>
    <script src="sequencer.js"></script>
    <script src="audio-player.js"></script>
    <script>
      const $ = id => document.getElementById(id);

// Initialize the sequencer and player
document.addEventListener('DOMContentLoaded', () => {
    const sequencerContainer = document.getElementById('sequencer');
    const midiManager = new MIDIManager();
    const player = new AudioWorkletPlayer(sequencerData, midiManager);
    const sequencer = new DataSequencer(sequencerContainer, player);
    
    // Function to update section display in UI
    function updateSectionDisplay() {
        const sectionInfo = player.getSectionInfo();
        const titleElement = document.getElementById('title');
        if (titleElement) {
            if (sectionInfo.isPlaying) {
                const followIndicator = sequencer.isFollowingPlayback ? ' 📍' : '';
                if (sectionInfo.playingIndex === sectionInfo.currentIndex) {
                    // Currently viewing the playing section
                    titleElement.textContent = `VibeSeq${followIndicator} - ${sectionInfo.currentName} (${sectionInfo.currentRepeat}/${sectionInfo.maxRepeats})`;
                } else {
                    // Viewing different section than what's playing
                    titleElement.textContent = `VibeSeq${followIndicator} - ${sectionInfo.currentName} [Playing: ${sectionInfo.playingName} (${sectionInfo.currentRepeat}/${sectionInfo.maxRepeats})]`;
                }
            } else {
                // Not playing
                titleElement.textContent = `VibeSeq - ${sectionInfo.currentName}`;
            }
        }
    }
    
    // Function to handle automatic section changes during playback
    function onAutomaticSectionChange() {
        // Use the new sequencer method that handles following logic
        sequencer.handleAutomaticSectionAdvance(player.playingSectionIndex);
        
        // Update the section display
        updateSectionDisplay();
        
        const sectionInfo = player.getSectionInfo();
        if (sequencer.isFollowingPlayback) {
            console.log(`Following playback to section: ${sectionInfo.playingName}`);
        } else {
            console.log(`Playback advanced to section: ${sectionInfo.playingName} (UI not following)`);
        }
    }
    
    // Monitor for automatic section changes during playback
    let lastPlayingSectionIndex = player.playingSectionIndex;
    setInterval(() => {
        if (player.isPlaying && player.playingSectionIndex !== lastPlayingSectionIndex) {
            lastPlayingSectionIndex = player.playingSectionIndex;
            onAutomaticSectionChange();
        }
        
        if (player.isPlaying) {
            updateSectionDisplay();
            
            // Also update section tabs periodically to maintain visual state
            const currentTabs = document.querySelectorAll('.section-tab');
            currentTabs.forEach((tab, index) => {
                const isPlaying = index === player.playingSectionIndex;
                const isActive = index === sequencer.currentSectionIndex;
                const isFollowing = sequencer.isFollowingPlayback && isPlaying;
                
                // Update classes without full re-render
                tab.classList.toggle('playing', isPlaying);
                tab.classList.toggle('active', isActive);
                tab.classList.toggle('following', isFollowing);
            });
        }
    }, 100); // Check every 100ms
    
    // Transport controls
    document.getElementById('play-button').addEventListener('click', () => {
        if (player.isPlaying) {
            player.stop();
            document.getElementById('play-button').textContent = 'Play';
            
            // Reset following when stopping
            sequencer.isFollowingPlayback = false;
            
            updateSectionDisplay(); // Reset display when stopping
            
            // Remove playing indicators from all tabs
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.classList.remove('playing', 'following');
            });
        } else {
            player.play();
            document.getElementById('play-button').textContent = 'Stop';
            
            // If starting playback on the current section, enable following
            if (player.currentSectionIndex === sequencer.currentSectionIndex) {
                sequencer.isFollowingPlayback = true;
                console.log('Starting playback on current section - following enabled');
            }
        }
    });
    
    // Tempo control - update current section's BPM
    document.getElementById('tempo').addEventListener('input', (e) => {
        const bpm = parseInt(e.target.value);
        player.setTempo(bpm);
        
        // Update the section BPM input in context menu
        const sectionBpmInput = document.getElementById('section-bpm-input');
        if (sectionBpmInput) {
            sectionBpmInput.value = bpm;
        }
    });
    
    // Sync tempo input with current section BPM
    function syncTempoInput() {
        const tempoInput = document.getElementById('tempo');
        const currentBpm = player.currentSection.bpm || 120;
        if (tempoInput && tempoInput.value != currentBpm) {
            tempoInput.value = currentBpm;
        }
    }
    
    // Monitor for manual section switches (UI navigation)
    let lastManualSectionIndex = sequencer.currentSectionIndex;
    setInterval(() => {
        if (sequencer.currentSectionIndex !== lastManualSectionIndex) {
            lastManualSectionIndex = sequencer.currentSectionIndex;
            
            // Update player to match sequencer's section (but don't stop playback)
            if (player.currentSectionIndex !== sequencer.currentSectionIndex) {
                player.switchToSection(sequencer.currentSectionIndex);
            }
            
            syncTempoInput();
            updateSectionDisplay();
            
            const followingStatus = sequencer.isFollowingPlayback ? ' (Following enabled)' : ' (Following disabled)';
            console.log(`Manual UI navigation to section: ${sequencer.currentSection.name}${followingStatus}`);
        }
    }, 50);
    
    // Initialize display
    updateSectionDisplay();
    syncTempoInput();
    
    // Initialize player track states
    player.updateTrackStates();
});
    </script>
</body>
</html>